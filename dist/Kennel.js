'use strict';

var _depiction,_proxyURL,_tint,_views,__classPrivateFieldSet=undefined&&undefined.__classPrivateFieldSet||function(e,i,t){if(!i.has(e))throw new TypeError("attempted to set private field on non-instance");return i.set(e,t),t},__classPrivateFieldGet=undefined&&undefined.__classPrivateFieldGet||function(e,i){if(!i.has(e))throw new TypeError("attempted to get private field on non-instance");return i.get(e)};const marked=require("marked");marked.setOptions({xhtml:!0,gfm:!1});class Kennel{constructor(e,i){_depiction.set(this,void 0),_proxyURL.set(this,void 0),_tint.set(this,void 0),_views.set(this,void 0);__classPrivateFieldSet(this,_depiction,void 0!==e?e:{minVersion:"0.1",tintColor:"#6264D3",class:"DepictionLabelView",text:"(This depiction is empty.)"}),__classPrivateFieldSet(this,_proxyURL,void 0!==i?i:""),__classPrivateFieldSet(this,_tint,void 0!==__classPrivateFieldGet(this,_depiction).tintColor?Kennel._sanitizeColor(__classPrivateFieldGet(this,_depiction).tintColor):"#6264d3"),__classPrivateFieldSet(this,_views,new Map),__classPrivateFieldGet(this,_views).set("DepictionStackView",e=>this._DepictionStackView(e)),__classPrivateFieldGet(this,_views).set("DepictionAutoStackView",e=>this._DepictionAutoStackView(e)),__classPrivateFieldGet(this,_views).set("DepictionTabView",e=>this._DepictionTabView(e)),__classPrivateFieldGet(this,_views).set("DepictionTableTextView",e=>this._DepictionTableTextView(e)),__classPrivateFieldGet(this,_views).set("DepictionTableButtonView",e=>this._DepictionTableButtonView(e)),__classPrivateFieldGet(this,_views).set("DepictionMarkdownView",e=>this._DepictionMarkdownView(e)),__classPrivateFieldGet(this,_views).set("DepictionLabelView",e=>this._DepictionLabelView(e)),__classPrivateFieldGet(this,_views).set("DepictionScreenshotsView",e=>this._DepictionScreenshotsView(e)),__classPrivateFieldGet(this,_views).set("DepictionSpacerView",e=>this._DepictionSpacerView(e)),__classPrivateFieldGet(this,_views).set("DepictionSeparatorView",e=>this._DepictionSeparatorView(e)),__classPrivateFieldGet(this,_views).set("DepictionHeaderView",e=>this._DepictionHeaderView(e)),__classPrivateFieldGet(this,_views).set("DepictionSubheaderView",e=>this._DepictionSubheaderView(e)),__classPrivateFieldGet(this,_views).set("DepictionButtonView",e=>this._DepictionButtonView(e)),__classPrivateFieldGet(this,_views).set("DepictionImageView",e=>this._DepictionImageView(e)),__classPrivateFieldGet(this,_views).set("DepictionRatingView",e=>this._DepictionRatingView(e)),__classPrivateFieldGet(this,_views).set("DepictionReviewView",e=>this._DepictionReviewView(e)),__classPrivateFieldGet(this,_views).set("DepictionWebView",e=>this._DepictionWebView(e)),__classPrivateFieldGet(this,_views).set("DepictionVideoView",e=>this._DepictionVideoView(e)),__classPrivateFieldGet(this,_views).set("DepictionAdmobView",e=>this._DepictionAdmobView(e));}render(){let e=Kennel._sanitizeColor(__classPrivateFieldGet(this,_tint)),i=`<div class="native_depiction"><style>a, .nd_tint, .nd_active {color: ${e}} .nd_active {border-bottom: 2px solid ${e};} .nd_btn {background-color: ${e}}</style>`;return i+=this._DepictionBaseView(__classPrivateFieldGet(this,_depiction)),i+="</div>",i}_DepictionBaseView(e){if(!e.class)return console.log("Kennel: Class for element is not defined."),e.class="UndefinedViewClass",this._DepictionErrorView(e,"Class for element is not defined");try{if(e.class.toLowerCase().includes("hidden"))return "";let i=__classPrivateFieldGet(this,_views).get(e.class);return "function"!=typeof i?this._DepictionUnknownView(e):i(e)}catch(i){return "TypeError"===i.name?(console.error("Kennel: Element is malformed."),this._DepictionErrorView(e,"Could not render malformed element")):(console.error("Kennel: An unknown error occurred."),this._DepictionErrorView(e,"An unknown error occurred during render"))}}_DepictionTabView(e){let i='<div class="nd_tabView">',t=Kennel._makeIdentifier("nd_tabView");i+='<div class="nd_nav">';for(let n=0;n<e.tabs.length;n++)i+=`<div class="${t} ${t}_tab_${n} nd_nav_btn nd_tweak_info_btn ${0==n?"nd_active":""}" onclick="ndChangeTab('.${t}_tab_${n}', '.${t}')">${Kennel._sanitize(e.tabs[n].tabname)}</div>`;i+="</div>",i+="<div>";for(let n=0;n<e.tabs.length;n++)i+=`<div class="nd_tab ${t} ${t}_tab_${n} ${n>0?"nd_hidden":""}">`,i+=this._DepictionBaseView(e.tabs[n]),i+="</div>";return i+="</div></div>",i}_DepictionStackView(e){let i="";if(void 0!==e.backgroundColor?i+=`<div class="nd_nested_stack" style="background: ${Kennel._sanitizeColor(e.backgroundColor)}">`:i+='<div class="nd_nested_stack">',void 0===e.orientation||"landscape"!=e.orientation.toLowerCase())for(let t=0;t<e.views.length;t++)i+=this._DepictionBaseView(e.views[t]);else {i+='<div class="nd_landscape_stack">';for(let t=0;t<e.views.length;t++)i+=this._DepictionBaseView(e.views[t]);i+="</div>";}return i+="</div>",i}_DepictionAutoStackView(e){let i="";if(void 0!==e.backgroundColor?i+=`<div class="nd_nested_stack" style="background: ${Kennel._sanitizeColor(e.backgroundColor)}; width: ${e.horizontalSpacing?Kennel._sanitizeDouble(e.horizontalSpacing)+"px":"100%"}">`:i+=`<div class="nd_nested_stack" style="width: ${e.horizontalSpacing?Kennel._sanitizeDouble(e.horizontalSpacing)+"px":"100%"}">`,void 0===e.orientation||"landscape"!=e.orientation.toLowerCase())for(let t=0;t<e.views.length;t++)i+=this._DepictionBaseView(e.views[t]);else {i+='<div class="nd_landscape_stack">';for(let t=0;t<e.views.length;t++)i+=this._DepictionBaseView(e.views[t]);i+="</div>";}return i+="</div>",i}_DepictionTableTextView(e){return `<div class="nd_table"><div class="nd_cell"><div class="nd_title">${Kennel._sanitize(e.title)}</div><div class="nd_text">${Kennel._sanitize(e.text)}</div></div></div>`}_DepictionTableButtonView(e){let i="";return e.openExternal&&(i+=' target="_blank"'),(e.yPadding||e.tintColor)&&(i+=' style="',e.yPadding&&(i+=`padding-bottom: '${Kennel._sanitizeDouble(e.yPadding)}';`),e.tintColor&&(i+=`color: ${Kennel._sanitizeColor(e.tintColor)};`),i+='"'),e.action=Kennel._sanitize(Kennel._buttonLinkHandler(e.action,e.title)),`<a class="nd nd_table-btn" href="${e.action}"${i}><div>${Kennel._sanitize(e.title)}</div></a>`}_DepictionButtonView(e){let i="";return e.openExternal&&(i+=' target="_blank"'),(e.yPadding||e.tintColor)&&(i+=' style="',e.yPadding&&(i+=`padding-bottom: '${Kennel._sanitizeDouble(e.yPadding)}';`),e.tintColor&&(i+=`background-color: ${Kennel._sanitizeColor(e.tintColor)};`),i+='"'),e.action=Kennel._sanitize(Kennel._buttonLinkHandler(e.action,e.text)),`<a class="nd nd_btn" href="${e.action}"${i}>${Kennel._sanitize(e.text)}</a>`}_DepictionMarkdownView(e){let i=!1,t=Kennel._makeIdentifier("md");void 0===e.tintColor&&void 0===__classPrivateFieldGet(this,_tint)?e.tintColor="#6264D3":void 0===e.tintColor&&void 0!==__classPrivateFieldGet(this,_tint)&&(e.tintColor=__classPrivateFieldGet(this,_tint));let n,s,l='<p style="opacity:0.3">[Warning: This depiction may be trying to maliciously run code in your browser.]</p><br>';if(e.useRawFormat?(n=marked(e.markdown).replace(/<hr>/gi,this._DepictionSeparatorView(e)),-1==n.toLowerCase().indexOf("<script>")&&-1==n.toLowerCase().indexOf("<\/script>")||(n=n.replace(/<script>/im,"&lt;script&gt;").replace(/<\/script>/im,"&lt;/script&gt;"),i=!0,n=`${l}${n}`),/on([^\s]+?)=/im.test(n)&&(i||(n=`${l}${n}`,i=!0),n=n.replace(/on([^\s]+?)=/gi,"onXSSAttempt="))):n=marked(Kennel._laxSanitize(e.markdown)).replace(/<hr>/g,this._DepictionSeparatorView(e)),-1!=n.indexOf("<style>")){let e=-1,i=-1;for(;-1!=n.indexOf("<style>",e+1);){e=n.indexOf("<style>",e),i=n.indexOf("</style>",i);let t=n.substring(e+7,i);t=t.replace(/body/g,"root").replace(/html/g,"root"),n=n.substring(0,e+7)+t+n.substring(i),e++,i++;}s=n.substring(0,n.indexOf("<style>"))+n.substring(n.indexOf("</style>")+8);}else s=n;return `<div id="${t}" class="nd_md_view"><noscript>${s}</noscript><script>mdEl = document.createElement("sandboxed-markdown");shadowRoot = mdEl.attachShadow({mode: 'open'});shadowRoot.innerHTML = \`<style>a {color:${Kennel._sanitizeColor(e.tintColor)};text-decoration: none} a:hover {opacity:0.8} h1, h2, h3, h4, h5, h6, p {margin-top: 5px; margin-bottom: 5px;}</style><root>${n}</root>\`;el = document.getElementById("${t}");el.appendChild(mdEl);el.removeAttribute("id");el.removeChild(el.children[0]);el.removeChild(el.children[0]);<\/script></div>`}_DepictionLabelView(e){let i;return i=void 0!==e.margins?Kennel._marginResolver(e.margins):"",e.alignment=Kennel._alignmentResolver(e.alignment),e.fontWeight=Kennel._weightStringResolver(e.fontWeight),e.textColor=void 0!==e.textColor?`color: ${Kennel._sanitizeColor(e.textColor)};`:"",e.fontSize=void 0!==e.fontSize?`font-size: ${Kennel._sanitizeDouble(e.fontSize)}px;`:"",`<div class="nd_label" style="font-weight: ${e.fontWeight}; text-align:${e.alignment}; ${e.textColor}${e.fontSize}${i}">${Kennel._sanitize(e.text)}</div>`}_DepictionScreenshotsView(e){let i='<div class="nd_scroll_view">',t=e.itemSize.substring(1,e.itemSize.length-1).split(","),n=Number(t[0]),s=Number(t[1]),l="";l=n>s?`width: ${Kennel._sanitizeDouble(n)}px`:`height: ${Kennel._sanitizeDouble(s)}px`;for(let t=0;t<e.screenshots.length;t++){let n=Kennel._laxSanitize(`${__classPrivateFieldGet(this,_proxyURL)}${e.screenshots[t].url}`);i+=`<img style="${Kennel._sanitize(l)}; border-radius: ${Kennel._sanitizeDouble(e.itemCornerRadius)}px" class="nd_img_card" alt="${Kennel._sanitize(e.screenshots[t].accessibilityText)}" src="${n}">`;}return i+="</div>",i}_DepictionSpacerView(e){return `<div class="nd_br" style="padding-top: ${Kennel._sanitizeDouble(e.spacing)}px"></div>`}_DepictionSeparatorView(e){return '<div class="nd_hr_wrap"><hr></div>'}_DepictionHeaderView(e){return e.fontWeight="bold",void 0!==e.useBoldText&&(e.fontWeight=e.useBoldText?"bold":"normal"),`<h3 class="nd_header" style="text-align: ${Kennel._alignmentResolver(e.alignment)};font-weight: ${Kennel._sanitize(e.fontWeight)}">${Kennel._sanitize(e.title)}</h3>`}_DepictionSubheaderView(e){return e.fontWeight="normal",void 0!==e.useBoldText&&(e.fontWeight=e.useBoldText?"bold":"normal"),`<h4 class="nd_header" style="text-align: ${Kennel._alignmentResolver(e.alignment)};font-weight: ${Kennel._sanitize(e.fontWeight)}">${Kennel._sanitize(e.title)}</h4>`}_DepictionImageView(e){let i=Kennel._laxSanitize(`${__classPrivateFieldGet(this,_proxyURL)}${e.URL}`),t=void 0!==e.horizontalPadding?`padding-top:${Kennel._sanitizeDouble(e.horizontalPadding)}px;padding-bottom:${Kennel._sanitizeDouble(e.horizontalPadding)}px;`:"";return e.alignment=Kennel._alignmentResolver(e.alignment),`<div style="text-align:${e.alignment};"><img src="${i}" style="width:${Kennel._sanitizeDouble(e.width)}px;height:${Kennel._sanitizeDouble(e.height)}px;border-radius:${Kennel._sanitizeDouble(e.cornerRadius)}px;max-width:100%;${t}" alt="Image from depiction."></div>`}_DepictionRatingView(e){let i=Kennel._starString(e.rating);return e.alignment=Kennel._alignmentResolver(e.alignment),`<div title="${Kennel._sanitizeDouble(e.rating)}/5 stars." style="color:#a1a1a1; text-align:${e.alignment};">${i}</div>`}_DepictionReviewView(e){let i,t=this._DepictionMarkdownView(e);return i=void 0!==e.rating?this._DepictionRatingView(e):"",`<div class="nd_review"><div class="nd_review_head"><div class="nd_left"><p>${Kennel._sanitize(e.title)}</p><p class="nd_author">by ${Kennel._sanitize(e.author)}</p></div><div class="nd_right">${i}</div></div>${t}</div>`}_DepictionWebView(e){return e.alignment=Kennel._alignmentResolver(e.alignment),`<div style="text-align: ${e.alignment}"><iframe class="nd_max_width" src="${Kennel._laxSanitize(e.URL)}" style="width: ${Kennel._sanitizeDouble(e.width)}px; height: ${Kennel._sanitizeDouble(e.height)}px;"></iframe></div>`}_DepictionVideoView(e){return `<div style="text-align: ${Kennel._alignmentResolver(e.alignment)};"><video class="nd_max_width" controls style="border-radius: ${Kennel._sanitizeDouble(e.cornerRadius)}px;" src="${Kennel._laxSanitize(e.URL)}" width="${Kennel._sanitizeDouble(e.width)}" height="${Kennel._sanitizeDouble(e.height)}"></video></div>`}_DepictionAdmobView(e){return ""}_DepictionUnknownView(e){return `<p style="opacity:0.3">[Could not render: ${Kennel._sanitize(e.class)}]</p>`}_DepictionErrorView(e,i){return `<p style="opacity:0.3;color:red">[${i}: ${Kennel._sanitize(e.class)}]</p>`}static _sanitize(e){e=String(e);let i="";for(let t=0;t<e.length;t++){let n=e[t];i+=n>="A"&&n<="z"||n>="0"&&n<="9"?n:`&#x${n.charCodeAt(0).toString(16).padStart(4,"0")};`;}return i}static _sanitizeDouble(e){let i=String(e),t="";for(let e=0;e<i.length;e++){let n=i[e];("."==n||n>="0"&&n<="9")&&(t+=n);}return t}static _sanitizeColor(e){e=String(e);let i="";for(let t=0;t<e.length;t++){let n=e[t];(n>="A"&&n<="z"||n>="0"&&n<="9"||"#"==n||"."==n||"-"==n||","==n||"("==n||")"==n)&&(i+=n);}return i}static _laxSanitize(e){e=String(e);let i="";for(let t=0;t<e.length;t++){let n=e[t];i+="&"==n||"<"==n||">"==n||'"'==n||"'"==n||"`"==n||"{"==n||"}"==n||"$"==n||"\\"==n||"/"==n?`&#x${n.charCodeAt(0).toString(16).padStart(4,"0")};`:n;}return i}static _makeIdentifier(e){return void 0===e&&(e="nd"),`${e}_${Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(36)}`}static _starString(e){return e=Math.round(e),"★".repeat(e).padEnd(5,"☆")}static _weightStringResolver(e){return void 0===e?"normal":"normal"==(e=e.toLowerCase())||"bold"==e||"bolder"==e||"lighter"==e?e:"ultralight"==e?"100":"thin"==e?"200":"light"==e?"300":"book"==e?"400":"semibold"==e||"Demibold"==e||"medium"==e?"600":"heavy"==e?"800":"black"==e||"extrablack"==e?"900":void 0}static _marginResolver(e){let i=JSON.parse(e.replace("{","[").replace("}","]"));return `margin: ${Kennel._sanitizeDouble(i[0])}px, ${Kennel._sanitizeDouble(i[3])}px, ${Kennel._sanitizeDouble(i[2])}px, ${Kennel._sanitizeDouble(i[1])}px;`}static _alignmentResolver(e){return 0==e?"left":1==e?"center":2==e?"right":"left"}static _buttonLinkHandler(e,i){const t=e.indexOf("javascript:");return -1!=t?e.substring(0,t)+encodeURIComponent(e.substring(t)):0==e.indexOf("depiction-")?(e=e.substring(10),void 0===i&&(i="Depiction"),`https://api.parcility.co/render/headerless?url=${encodeURIComponent(e)}&name=${i}`):0==e.indexOf("form-")?e.substring(4):e}}_depiction=new WeakMap,_proxyURL=new WeakMap,_tint=new WeakMap,_views=new WeakMap;

module.exports = Kennel;
